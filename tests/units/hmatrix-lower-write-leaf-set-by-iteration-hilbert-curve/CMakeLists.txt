find_package(Octave REQUIRED)

set(TEST_TARGET hmatrix-lower-write-leaf-set-by-iteration-hilbert-curve)

# Link TEST_TARGET to my generic_tools library.
set(TEST_LIBRARIES generic_tools hbem_octave_wrapper ${OCTAVE_LIBRARIES})

deal_ii_pickup_tests()

# Get the last folder name in ${CMAKE_CURRENT_SOURCE_DIR} as the category of the
# test.
string(REGEX MATCH "/([^/]+)$" _matched_string ${CMAKE_CURRENT_SOURCE_DIR})
set(_category ${CMAKE_MATCH_1})
string(TOLOWER ${CMAKE_BUILD_TYPE} _build_type_lower)
# The actual target name generated by deal_ii_add_test.
set(_target ${_category}.${TEST_TARGET}.${_build_type_lower})
# The folder for the generated target.
set(_build_folder
    "${CMAKE_CURRENT_BINARY_DIR}/${TEST_TARGET}.${_build_type_lower}")

# Define SOURCE_DIR macro to be used in the source files
target_compile_definitions(${_target}
                           PUBLIC SOURCE_DIR="${CMAKE_CURRENT_SOURCE_DIR}")

add_custom_command(
  TARGET ${_target}
  POST_BUILD
  COMMAND ${CMAKE_COMMAND} -E copy ${CMAKE_CURRENT_SOURCE_DIR}/draw.m
          ${_build_folder}/draw.m)
